<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الملف الشخصي - أيين</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* --- منع التحديد والإبراز والقائمة المنبثقة على جميع العناصر --- */
        button, a, input, textarea, select {
            outline: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        button:active, a:active {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Main Content */
        main {
            padding: 20px;
            min-height: 100vh;
            width: 100%;
        }

        /* Profile Header */
        .profile-header {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.8s ease;
        }

        .profile-header h1 {
            font-size: 1.8rem;
            color: #1a2a6c;
            margin-bottom: 10px;
        }

        .profile-header .company-name {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 20px;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a2a6c;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Posts Section */
        .posts-section {
            margin-top: 20px;
        }

        .posts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .post-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease;
            transition: transform 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-5px);
        }

        .post-image-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            cursor: pointer;
        }

        .post-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-count-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: none;
        }

        .post-content {
            padding: 15px;
        }

        .post-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a2a6c;
            margin-bottom: 10px;
        }

        .post-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .post-details {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            border-right: 3px solid #1a2a6c;
        }

        .post-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .post-detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #1a2a6c;
            font-weight: 600;
            text-align: left;
        }

        .price-section {
            background: linear-gradient(135deg, #1a2a6c, #2a3f8f);
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .price-amount {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .price-negotiable {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .notes-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.85rem;
            color: #856404;
        }

        .post-date {
            font-size: 0.8rem;
            color: #888;
            text-align: left;
        }

        .post-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(90deg, #1a2a6c, #2a3f8f);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .btn:hover {
            background: linear-gradient(90deg, #0f1a4a, #1a2a6c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 42, 108, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            margin: 20px 0;
            animation: slideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 800px;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: #1a2a6c;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
            font-family: 'Tajawal', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #1a2a6c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 42, 108, 0.1);
            background-color: #fff;
        }

        .form-group input:disabled,
        .form-group textarea:disabled {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
        }

        .modal-btn.primary {
            background-color: #1a2a6c;
            color: white;
        }

        .modal-btn.primary:hover {
            background-color: #0f1a4a;
        }

        .modal-btn.secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background-color: #d0d0d0;
        }

        .modal-btn.danger {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn.danger:hover {
            background-color: #c82333;
        }

        .modal-btn.success {
            background-color: #28a745;
            color: white;
        }

        .modal-btn.success:hover {
            background-color: #218838;
        }

        /* Gallery Styles */
        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .gallery-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .gallery-thumbnail:hover {
            transform: scale(1.05);
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 3001;
        }

        /* Contact Modal */
        .contact-info {
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .contact-item i {
            margin-left: 10px;
            color: #1a2a6c;
            font-size: 1.2rem;
        }

        .contact-item a {
            color: #1a2a6c;
            text-decoration: none;
            font-weight: 500;
        }

        .contact-item a:hover {
            text-decoration: underline;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            display: none;
            animation: slideInRight 0.5s ease;
            color: white;
            font-size: 0.9rem;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.error {
            background-color: #f44336;
        }

        /* Password Recovery Link */
        .password-recovery {
            text-align: center;
            margin-top: 10px;
        }

        .password-recovery a {
            color: #1a2a6c;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .password-recovery a:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .posts-container {
                grid-template-columns: 1fr;
            }
            
            .profile-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .profile-stats {
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                padding: 20px;
            }
            
            .profile-header h1 {
                font-size: 1.5rem;
            }
            
            .profile-header .company-name {
                font-size: 1rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- أنماط إضافية للمنشورات والأزرار --- */
        .post-availability {
            font-size: 0.9rem;
            color: #1a2a6c;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .post-price {
            font-size: 1rem;
            color: #28a745;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .post-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* --- أنماط نافذة التفاصيل --- */
        .details-item {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .details-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .details-label {
            font-weight: 600;
            color: #1a2a6c;
            min-width: 120px;
            margin-left: 15px;
        }

        .details-value {
            color: #333;
            flex: 1;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <!-- المحتوى الرئيسي -->
    <main>
        <!-- رأس الملف الشخصي -->
        <div class="profile-header">
            <h1 id="profileName">اسم المستخدم</h1>
            <div class="company-name" id="profileCompany">اسم الشركة</div>
            
            <div class="profile-actions" id="profileActions">
                <!-- سيتم ملؤه ديناميكيًا -->
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number" id="postsCount">0</div>
                    <div class="stat-label">المنشورات</div>
                </div>
            </div>
        </div>

        <!-- قسم المنشورات -->
        <div class="posts-section">
            <div class="posts-container" id="postsContainer">
                <!-- سيتم ملؤه ديناميكيًا -->
            </div>
        </div>
    </main>

    <!-- نافذة المعلومات الشخصية -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>المعلومات الشخصية</h2>
                <button class="close-btn" id="closeProfileModal">&times;</button>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label for="full_name">الاسم الكامل</label>
                    <input type="text" id="full_name" name="full_name" disabled>
                </div>
                
                <div class="form-group">
                    <label for="birth_date">تاريخ الميلاد</label>
                    <input type="date" id="birth_date" name="birth_date" disabled>
                </div>
                
                <div class="form-group">
                    <label for="address">العنوان</label>
                    <textarea id="address" name="address" disabled></textarea>
                </div>
                
                <div class="form-group">
                    <label for="phone1">رقم الهاتف الرئيسي</label>
                    <input type="tel" id="phone1" name="phone1" disabled>
                </div>
                
                <div class="form-group">
                    <label for="phone2">رقم هاتف إضافي (اختياري)</label>
                    <input type="tel" id="phone2" name="phone2" disabled>
                </div>
                
                <div class="form-group">
                    <label for="company_name">اسم الشركة (اختياري)</label>
                    <input type="text" id="company_name" name="company_name" disabled>
                </div>
                
                <div class="form-group" id="passwordFields" style="display: none;">
                    <label for="newPassword">كلمة المرور الجديدة (اتركها فارغة للحفاظ على الحالية)</label>
                    <input type="password" id="newPassword" name="newPassword">
                </div>
                
                <div class="form-group" id="confirmPasswordFields" style="display: none;">
                    <label for="confirmPassword">تأكيد كلمة المرور الجديدة</label>
                    <input type="password" id="confirmPassword" name="confirmPassword">
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn primary" id="editProfileBtn">تعديل</button>
                    <button type="submit" class="modal-btn success" id="saveProfileBtn" style="display: none;">حفظ التعديلات</button>
                    <button type="button" class="modal-btn secondary" id="cancelEditBtn" style="display: none;">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة الاتصال -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>معلومات الاتصال</h2>
                <button class="close-btn" id="closeContactModal">&times;</button>
            </div>
            
            <div class="contact-info" id="contactInfo">
                <!-- سيتم ملؤه ديناميكيًا -->
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" id="callBtn">اتصال</button>
                <button class="modal-btn secondary" id="closeContactBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة التحقق من كلمة المرور -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>التحقق من كلمة المرور</h2>
                <button class="close-btn" id="closePasswordModal">&times;</button>
            </div>
            
            <p>لإتمام هذا الإجراء، يرجى إدخال كلمة المرور الحالية.</p>
            
            <div class="form-group">
                <input type="password" id="modalPasswordInput" placeholder="كلمة المرور الحالية">
            </div>
            
            <div class="password-recovery">
                <a href="pass.html">لا أتذكر كلمة المرور</a>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" id="confirmPasswordBtn">تأكيد</button>
                <button class="modal-btn secondary" id="cancelPasswordBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد حذف الحساب -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تحذير!</h2>
                <button class="close-btn" id="closeDeleteModal">&times;</button>
            </div>
            
            <p>هل أنت متأكد من أنك تريد حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه وسيؤدي إلى حذف جميع بياناتك بشكل نهائي.</p>
            
            <div class="modal-buttons">
                <button class="modal-btn danger" id="confirmDeleteBtn">حذف الحساب</button>
                <button class="modal-btn secondary" id="cancelDeleteBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة الخريطة -->
    <div id="mapModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>موقع العقار على الخريطة</h2>
                <button class="close-btn" id="closeMapModal">&times;</button>
            </div>
            <div id="map" style="height: 450px; width: 100%; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- نافذة التفاصيل -->
    <div id="detailsModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>تفاصيل العقار</h2>
                <button class="close-btn" id="closeDetailsModal">&times;</button>
            </div>
            <div id="detailsContent" style="padding: 10px 0;">
                <!-- سيتم ملؤه ديناميكيًا -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeDetailsBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة معرض الصور -->
    <div id="galleryModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>معرض الصور</h2>
                <button class="close-btn" id="closeGalleryModal">&times;</button>
            </div>
            <div id="galleryContent" style="padding: 10px 0;">
                <!-- سيتم ملؤه ديناميكيًا -->
            </div>
        </div>
    </div>

    <!-- نافذة عرض الصورة المفردة -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" id="closeImageModal">&times;</span>
        <img id="modalImage" class="image-modal-content">
    </div>

    <!-- رسالة الإشعار -->
    <div id="notification" class="notification"></div>

    <script>
        // تم تصحيح الخطأ المتعلق بتمرير بيانات JSON في خصائص onclick
        // تم استخدام data-* attributes بدلاً من ذلك لضمان التوافق والأمان

        // إعداد Supabase
        const { createClient } = supabase;
        const supabaseUrl = 'https://rastimuoifacxcitljdw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhc3RpbXVvaWZhY3hjaXRsamR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzODYxOTIsImV4cCI6MjA3NTk2MjE5Mn0.xOW2p17zvHy9z8n4q-T__jgiNE83N927oRs2Max13RQ';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // عناصر DOM
        const profileName = document.getElementById('profileName');
        const profileCompany = document.getElementById('profileCompany');
        const profileActions = document.getElementById('profileActions');
        const postsCount = document.getElementById('postsCount');
        const postsContainer = document.getElementById('postsContainer');
        
        // عناصر النوافذ المنبثقة
        const profileModal = document.getElementById('profileModal');
        const contactModal = document.getElementById('contactModal');
        const passwordModal = document.getElementById('passwordModal');
        const deleteModal = document.getElementById('deleteModal');
        const mapModal = document.getElementById('mapModal');
        const detailsModal = document.getElementById('detailsModal');
        const galleryModal = document.getElementById('galleryModal');
        const imageModal = document.getElementById('imageModal');
        const modalPasswordInput = document.getElementById('modalPasswordInput');
        const notification = document.getElementById('notification');
        
        // عناصر النموذج
        const profileForm = document.getElementById('profileForm');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const passwordFields = document.getElementById('passwordFields');
        const confirmPasswordFields = document.getElementById('confirmPasswordFields');
        
        // عناصر نافذة الاتصال
        const contactInfo = document.getElementById('contactInfo');
        const callBtn = document.getElementById('callBtn');
        
        // متغيرات عامة
        let currentUserData = null;
        let profileUserData = null;
        let isEditMode = false;
        let actionToPerform = null;
        let phoneNumberToCall = null;
        let map = null;
        let marker = null;
        let currentPostImages = [];

        // عرض إشعار
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // التحقق من حالة تسجيل الدخول
        async function checkLoginStatus() {
            try {
                const currentUserData = localStorage.getItem('currentUser');
                
                if (!currentUserData) {
                    setGuestMode();
                    return { isLoggedIn: false, userData: null };
                }
                
                const userData = JSON.parse(currentUserData);
                
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('chek')
                    .select('*')
                    .eq('user_id', userData.id)
                    .eq('is_logged_in', true)
                    .single();
                
                if (checkError || !checkData) {
                    localStorage.removeItem('currentUser');
                    setGuestMode();
                    return { isLoggedIn: false, userData: null };
                }
                
                const now = new Date().toISOString();
                await supabaseClient
                    .from('chek')
                    .update({ last_activity: now })
                    .eq('user_id', userData.id);
                
                return { isLoggedIn: true, userData: userData };
                
            } catch (error) {
                console.error('Error checking login status:', error);
                localStorage.removeItem('currentUser');
                setGuestMode();
                return { isLoggedIn: false, userData: null };
            }
        }

        // الحصول على معرف المستخدم من URL
        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // تحميل بيانات المستخدم
        async function loadUserData(userId) {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('Error loading user data:', error);
                    showNotification('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
                return null;
            }
        }

        // تحميل منشورات المستخدم (محدث مع الفلترة)
        async function loadUserPosts(userId) {
            try {
                // الحصول على البيانات من جدول msg3 مع فلترة الحالة
                let { data, error } = await supabaseClient
                    .from('msg3')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('post_status', 'الإعلان نشط الان')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading user posts from msg3:', error);
                    showNotification('حدث خطأ أثناء تحميل المنشورات', 'error');
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('Error loading user posts:', error);
                showNotification('حدث خطأ أثناء تحميل المنشورات', 'error');
                return [];
            }
        }

        // الحصول على رابط الصورة من Storage
        function getImageUrl(imagePath) {
            if (!imagePath) return 'ard.png';
            
            // إذا كان الرابط يحتوي على مسار كامل، استخدمه مباشرة
            if (imagePath.startsWith('http')) {
                return imagePath;
            }
            
            // إذا كان الرابط يحتوي على اسم ملف فقط، قم ببناء الرابط الصحيح
            if (imagePath.includes('/')) {
                const { data } = supabaseClient.storage
                    .from('property-images')
                    .getPublicUrl(imagePath);
                return data.publicUrl;
            } else {
                // إذا كان اسم ملف فقط، أضفه إلى المسار الافتراضي
                const { data } = supabaseClient.storage
                    .from('property-images')
                    .getPublicUrl(imagePath);
                return data.publicUrl;
            }
        }

        // معالجة الصور من حقل images (يمكن أن تكون سلسلة أو مصفوفة)
        function processImages(imagesData) {
            if (!imagesData) return ['ard.png'];
            
            try {
                // إذا كانت imagesData سلسلة JSON
                if (typeof imagesData === 'string') {
                    const parsed = JSON.parse(imagesData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        return parsed.map(img => getImageUrl(img));
                    }
                }
                
                // إذا كانت مصفوفة مباشرة
                if (Array.isArray(imagesData) && imagesData.length > 0) {
                    return imagesData.map(img => getImageUrl(img));
                }
                
                // إذا كانت سلسلة عادية (صورة واحدة)
                if (typeof imagesData === 'string' && imagesData.trim() !== '') {
                    return [getImageUrl(imagesData)];
                }
            } catch (error) {
                console.error('Error processing images:', error);
                // إذا فشل التحليل، عالج كسلسلة عادية
                if (typeof imagesData === 'string' && imagesData.trim() !== '') {
                    return [getImageUrl(imagesData)];
                }
            }
            
            return ['ard.png'];
        }

        // تنسيق السعر بشكل صحيح
        function formatPrice(price) {
            if (!price) return '';
            
            // تحويل السعر إلى رقم
            const numPrice = Number(price);
            if (isNaN(numPrice)) return price;
            
            // تنسيق السعر مع فواصل الآلاف
            return numPrice.toLocaleString('ar-EG') + ' دينار';
        }

        // عرض المنشورات (محدث بالكامل)
        function displayPosts(posts) {
            postsContainer.innerHTML = '';
            
            if (posts.length === 0) {
                postsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #fff;">لا توجد إعلانات نشطة حالياً</div>';
                return;
            }
            
            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                
                // معالجة الصور
                const images = processImages(post.images);
                const mainImage = images[0];
                const imageCount = images.length;
                
                // بناء نص "متوفر"
                let availabilityText = 'متوفر';
                if (post.offer_type) availabilityText += ` ${post.offer_type}`;
                if (post.property_type) availabilityText += ` ${post.property_type}`;
                if (post.property_condition) availabilityText += ` (${post.property_condition})`;
                if (post.governorate) availabilityText += ` في ${post.governorate}`;
                if (post.precise_address) availabilityText += `، ${post.precise_address}`;

                // بناء نص السعر
                let priceText = '';
                if (post.price) {
                    const formattedPrice = formatPrice(post.price);
                    priceText = `بسعر ${formattedPrice}`;
                    
                    if (post.price_negotiable === 'true' || post.price_negotiable === true) {
                        priceText += ' (قابل للتفاوض)';
                    } else {
                        priceText += ' (سعر نهائي)';
                    }
                }
                
                postCard.innerHTML = `
                    <div class="post-image-container" data-post='${JSON.stringify(post)}' onclick="openGalleryModal(this)">
                        <img src="${mainImage}" alt="${post.request_type || 'عقار'}" class="post-image" onerror="this.src='ard.png'">
                        ${imageCount > 1 ? `<div class="image-count-badge">${imageCount} صور</div>` : ''}
                    </div>
                    <div class="post-content">
                        <div class="post-availability">${availabilityText}</div>
                        ${priceText ? `<div class="post-price">${priceText}</div>` : ''}
                        
                        <div class="post-details">
                            <div class="post-detail-row">
                                <span class="detail-label">نوع العرض:</span>
                                <span class="detail-value">${post.offer_type || 'غير محدد'}</span>
                            </div>
                            <div class="post-detail-row">
                                <span class="detail-label">نوع العقار:</span>
                                <span class="detail-value">${post.property_type || 'غير محدد'}</span>
                            </div>
                            <div class="post-detail-row">
                                <span class="detail-label">المحافظة:</span>
                                <span class="detail-value">${post.governorate || 'غير محدد'}</span>
                            </div>
                            <div class="post-detail-row">
                                <span class="detail-label">العنوان الدقيق:</span>
                                <span class="detail-value">${post.precise_address || 'غير محدد'}</span>
                            </div>
                        </div>
                        
                        ${post.notes ? `
                            <div class="notes-section">
                                <strong>ملاحظات:</strong> ${post.notes}
                            </div>
                        ` : ''}
                        
                        <div class="post-actions">
                            <button class="btn btn-secondary" data-location="${post.location || ''}" onclick="openMapModal(this)">
                                <i class="fas fa-map-marked-alt"></i> الموقع
                            </button>
                            <button class="btn" data-post='${JSON.stringify(post)}' onclick="openDetailsModal(this)">
                                <i class="fas fa-info-circle"></i> التفاصيل
                            </button>
                        </div>
                    </div>
                `;
                
                postsContainer.appendChild(postCard);
            });
        }

        // فتح نافذة معرض الصور
        function openGalleryModal(element) {
            const post = JSON.parse(element.getAttribute('data-post'));
            const galleryContent = document.getElementById('galleryContent');
            const images = processImages(post.images);
            
            let galleryHtml = '';
            
            if (images.length === 0) {
                galleryHtml = '<p style="text-align: center; color: #888;">لا توجد صور متاحة.</p>';
            } else {
                galleryHtml = '<div class="gallery-container">';
                images.forEach((img, index) => {
                    galleryHtml += `
                        <img src="${img}" alt="صورة ${index + 1}" class="gallery-thumbnail" 
                             onclick="openImageModal('${img}')" onerror="this.src='ard.png'">
                    `;
                });
                galleryHtml += '</div>';
            }
            
            galleryContent.innerHTML = galleryHtml;
            galleryModal.style.display = 'flex';
        }

        // فتح نافذة الصورة المفردة
        function openImageModal(imageUrl) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            imageModal.style.display = 'flex';
        }

        // تفعيل وضع عرض الملف الشخصي الخاص
        function setOwnProfileMode(userData) {
            profileUserData = userData;
            
            // عرض اسم المستخدم والشركة
            profileName.textContent = userData.full_name || 'مستخدم';
            profileCompany.textContent = userData.company_name || '';
            
            // عرض الأزرار
            profileActions.innerHTML = `
                <button class="btn" id="personalInfoBtn">
                    <i class="fas fa-user"></i> المعلومات الشخصية
                </button>
                <button class="btn btn-danger" id="deleteAccountBtn">
                    <i class="fas fa-trash-alt"></i> حذف الحساب
                </button>
            `;
            
            // إضافة مستمعي الأحداث
            document.getElementById('personalInfoBtn').addEventListener('click', openProfileModal);
            document.getElementById('deleteAccountBtn').addEventListener('click', openDeleteModal);
        }

        // تفعيل وضع عرض الملف الشخصي لآخرين
        function setOtherProfileMode(userData) {
            profileUserData = userData;
            
            // عرض اسم الشركة أو اسم المستخدم
            if (userData.company_name) {
                profileName.textContent = userData.company_name;
                profileCompany.textContent = userData.full_name || '';
            } else {
                profileName.textContent = userData.full_name || 'مستخدم';
                profileCompany.textContent = '';
            }
            
            // عرض الأزرار
            profileActions.innerHTML = `
                <button class="btn" id="contactBtn">
                    <i class="fas fa-phone"></i> اتصال
                </button>
                <a href="msg.html?id=${userData.id}" class="btn btn-secondary">
                    <i class="fas fa-envelope"></i> استفسار
                </a>
            `;
            
            // إضافة مستمعي الأحداث
            document.getElementById('contactBtn').addEventListener('click', openContactModal);
        }

        // تفعيل وضع الزائر
        function setGuestMode() {
            profileUserData = null;
            
            // عرض رسالة للمستخدم
            document.querySelector('main').innerHTML = `
                <div style="text-align: center; color: #fff; padding: 40px 20px;">
                    <h2 style="margin-bottom: 20px;">يجب تسجيل الدخول</h2>
                    <p style="margin-bottom: 25px;">لعرض الملف الشخصي، يرجى تسجيل الدخول أولاً</p>
                    <a href="login.html" class="btn" style="display: inline-block; width: auto; padding: 10px 25px;">تسجيل الدخول</a>
                </div>
            `;
        }

        // فتح نافذة المعلومات الشخصية
        function openProfileModal() {
            loadUserProfile();
            profileModal.style.display = 'flex';
        }

        // تحميل بيانات المستخدم في النموذج
        function loadUserProfile() {
            if (!profileUserData) return;
            
            document.getElementById('full_name').value = profileUserData.full_name || '';
            document.getElementById('birth_date').value = profileUserData.birth_date || '';
            document.getElementById('address').value = profileUserData.address || '';
            document.getElementById('phone1').value = profileUserData.phone1 || '';
            document.getElementById('phone2').value = profileUserData.phone2 || '';
            document.getElementById('company_name').value = profileUserData.company_name || '';
            
            // إعادة تعيين وضع العرض
            setViewMode();
        }

        // تفعيل وضع العرض
        function setViewMode() {
            isEditMode = false;
            
            // تعطيل الحقول
            document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(field => {
                field.disabled = true;
            });
            
            // إخفاء حقول كلمة المرور
            passwordFields.style.display = 'none';
            confirmPasswordFields.style.display = 'none';
            
            // عرض زر التعديل وإخفاء أزرار الحفظ والإلغاء
            editProfileBtn.style.display = 'block';
            saveProfileBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
        }

        // تفعيل وضع التعديل
        function setEditMode() {
            isEditMode = true;
            
            // تفعيل الحقول
            document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(field => {
                field.disabled = false;
            });
            
            // عرض حقول كلمة المرور
            passwordFields.style.display = 'block';
            confirmPasswordFields.style.display = 'block';
            
            // إخفاء زر التعديل وعرض أزرار الحفظ والإلغاء
            editProfileBtn.style.display = 'none';
            saveProfileBtn.style.display = 'block';
            cancelEditBtn.style.display = 'block';
        }

        // فتح نافذة الاتصال
        function openContactModal() {
            if (!profileUserData) return;
            
            let contactHtml = '';
            
            if (profileUserData.phone1) {
                contactHtml += `
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <a href="tel:${profileUserData.phone1}">${profileUserData.phone1}</a>
                    </div>
                `;
                phoneNumberToCall = profileUserData.phone1;
            }
            
            if (profileUserData.phone2) {
                contactHtml += `
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <a href="tel:${profileUserData.phone2}">${profileUserData.phone2}</a>
                    </div>
                `;
                if (!phoneNumberToCall) phoneNumberToCall = profileUserData.phone2;
            }
            
            if (profileUserData.address) {
                contactHtml += `
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${profileUserData.address}</span>
                    </div>
                `;
            }
            
            contactInfo.innerHTML = contactHtml || '<p>لا توجد معلومات اتصال متاحة</p>';
            contactModal.style.display = 'flex';
        }

        // فتح نافذة حذف الحساب
        function openDeleteModal() {
            deleteModal.style.display = 'flex';
        }

        // التحقق من كلمة المرور ثم تنفيذ إجراء
        async function verifyPasswordThen(action) {
            actionToPerform = action;
            passwordModal.style.display = 'flex';
            modalPasswordInput.value = '';
            modalPasswordInput.focus();
        }

        // التحقق من كلمة المرور
        async function checkPassword() {
            const password = modalPasswordInput.value;
            if (!password) {
                showNotification('يرجى إدخال كلمة المرور', 'error');
                return;
            }

            const { data, error } = await supabaseClient
                .from('users')
                .select('password')
                .eq('id', currentUserData.id)
                .single();

            if (error || !data || data.password !== password) {
                showNotification('كلمة المرور غير صحيحة', 'error');
                return;
            }

            passwordModal.style.display = 'none';
            if (actionToPerform) actionToPerform();
        }

        // حفظ التغييرات
        async function saveProfile() {
            const formData = new FormData(profileForm);
            const updatedData = {};
            
            // التحقق من الحقول المحمية
            const protectedFieldsChanged = 
                formData.get('full_name') !== profileUserData.full_name ||
                formData.get('phone1') !== profileUserData.phone1 ||
                formData.get('newPassword');

            if (protectedFieldsChanged) {
                await verifyPasswordThen(() => performSave());
            } else {
                await performSave();
            }
        }

        // تنفيذ عملية الحفظ
        async function performSave() {
            const formData = new FormData(profileForm);
            const updatedData = {
                full_name: formData.get('full_name'),
                birth_date: formData.get('birth_date'),
                address: formData.get('address'),
                phone1: formData.get('phone1'),
                phone2: formData.get('phone2'),
                company_name: formData.get('company_name'),
                updated_at: new Date().toISOString()
            };

            // التحقق من كلمة المرور الجديدة
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (newPassword) {
                if (newPassword !== confirmPassword) {
                    showNotification('كلمتا المرور الجديدة غير متطابقتين', 'error');
                    return;
                }
                updatedData.password = newPassword;
            }

            const { error } = await supabaseClient
                .from('users')
                .update(updatedData)
                .eq('id', profileUserData.id);

            if (error) {
                console.error('Error updating profile:', error);
                showNotification('حدث خطأ أثناء حفظ التغييرات', 'error');
            } else {
                // تحديث البيانات في المتغيرات
                Object.assign(profileUserData, updatedData);
                
                // إذا كان المستخدم الحالي، تحديث التخزين المحلي
                if (currentUserData && currentUserData.id === profileUserData.id) {
                    Object.assign(currentUserData, updatedData);
                    localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                    
                    // تحديث العرض في الصفحة
                    profileName.textContent = profileUserData.full_name || 'مستخدم';
                    profileCompany.textContent = profileUserData.company_name || '';
                }
                
                showNotification('تم حفظ التغييرات بنجاح');
                
                // العودة إلى وضع العرض
                setViewMode();
                
                // مسح حقول كلمة المرور
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
        }

        // حذف الحساب
        async function performDeleteAccount() {
            deleteModal.style.display = 'none';
            await verifyPasswordThen(async () => {
                try {
                    // حذف من جدول chek
                    await supabaseClient.from('chek').delete().eq('user_id', currentUserData.id);
                    
                    // حذف من جدول users
                    const { error } = await supabaseClient.from('users').delete().eq('id', currentUserData.id);
                    
                    if (error) {
                        console.error('Error deleting account:', error);
                        showNotification('حدث خطأ أثناء حذف الحساب', 'error');
                    } else {
                        localStorage.removeItem('currentUser');
                        showNotification('تم حذف حسابك بنجاح', 'success');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error during account deletion:', error);
                    showNotification('حدث خطأ أثناء حذف الحساب', 'error');
                }
            });
        }

        // فتح نافذة الخريطة
        function openMapModal(element) {
            const locationString = element.getAttribute('data-location');
            if (!locationString) {
                showNotification('لا توجد إحداثيات متاحة لهذا العقار', 'error');
                return;
            }

            const coords = locationString.split(',').map(coord => parseFloat(coord.trim()));
            if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
                showNotification('تنسيق الإحداثيات غير صالح', 'error');
                return;
            }

            mapModal.style.display = 'flex';

            // تهيئة الخريطة فقط في المرة الأولى
            if (!map) {
                map = L.map('map').setView(coords, 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                marker = L.marker(coords).addTo(map);
            } else {
                // تحديث عرض الخريطة والعلامة للمكالمات اللاحقة
                map.setView(coords, 15);
                marker.setLatLng(coords);
            }
        }

        // فتح نافذة التفاصيل
        function openDetailsModal(element) {
            const post = JSON.parse(element.getAttribute('data-post'));
            const detailsContent = document.getElementById('detailsContent');
            
            let detailsHtml = '';
            
            const fields = [
                { label: 'رقم العقار', value: post.property_number },
                { label: 'نوع او صنف العقار', value: post.deed_type },
                { label: 'المساحة', value: (post.area_number && post.area_unit) ? `${post.area_number} ${post.area_unit}` : (post.area_number || post.area_unit) },
                { label: 'الحالة', value: post.property_condition },
                { label: 'مميزات العقار', value: post.features },
                { label: 'ملاحظات', value: post.notes }
            ];

            fields.forEach(field => {
                if (field.value) {
                    detailsHtml += `
                        <div class="details-item">
                            <div class="details-label">${field.label}:</div>
                            <div class="details-value">${field.value}</div>
                        </div>
                    `;
                }
            });

            if (!detailsHtml) {
                detailsHtml = '<p style="text-align: center; color: #888;">لا توجد تفاصيل إضافية متاحة.</p>';
            }

            detailsContent.innerHTML = detailsHtml;
            detailsModal.style.display = 'flex';
        }

        // مستمعي الأحداث
        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveProfile();
        });

        editProfileBtn.addEventListener('click', setEditMode);
        cancelEditBtn.addEventListener('click', setViewMode);

        // مستمعي النوافذ المنبثقة
        document.getElementById('closeProfileModal').addEventListener('click', () => {
            profileModal.style.display = 'none';
            setViewMode();
        });

        document.getElementById('closeContactModal').addEventListener('click', () => {
            contactModal.style.display = 'none';
        });

        document.getElementById('closeContactBtn').addEventListener('click', () => {
            contactModal.style.display = 'none';
        });

        document.getElementById('closePasswordModal').addEventListener('click', () => {
            passwordModal.style.display = 'none';
        });

        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            deleteModal.style.display = 'none';
        });

        document.getElementById('confirmPasswordBtn').addEventListener('click', checkPassword);
        document.getElementById('cancelPasswordBtn').addEventListener('click', () => {
            passwordModal.style.display = 'none';
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', performDeleteAccount);
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            deleteModal.style.display = 'none';
        });

        // إضافة مستمعي الأحداث للنوافذ الجديدة
        document.getElementById('closeGalleryModal').addEventListener('click', () => {
            galleryModal.style.display = 'none';
        });

        document.getElementById('closeImageModal').addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        document.getElementById('closeMapModal').addEventListener('click', () => {
            mapModal.style.display = 'none';
        });

        document.getElementById('closeDetailsModal').addEventListener('click', () => {
            detailsModal.style.display = 'none';
        });

        document.getElementById('closeDetailsBtn').addEventListener('click', () => {
            detailsModal.style.display = 'none';
        });

        callBtn.addEventListener('click', () => {
            if (phoneNumberToCall) {
                window.location.href = `tel:${phoneNumberToCall}`;
            }
        });

        // إغلاق النوافذ عند الضغط خارجها
        window.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.style.display = 'none';
                setViewMode();
            }
            if (e.target === contactModal) {
                contactModal.style.display = 'none';
            }
            if (e.target === passwordModal) {
                passwordModal.style.display = 'none';
            }
            if (e.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
            if (e.target === mapModal) {
                mapModal.style.display = 'none';
            }
            if (e.target === detailsModal) {
                detailsModal.style.display = 'none';
            }
            if (e.target === galleryModal) {
                galleryModal.style.display = 'none';
            }
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            // التحقق من حالة تسجيل الدخول
            const { isLoggedIn, userData } = await checkLoginStatus();
            currentUserData = userData;
            
            // الحصول على معرف المستخدم من URL
            const userId = getUserIdFromUrl();
            
            if (!userId) {
                // إذا لم يتم تحديد معرف، عرض الملف الشخصي للمستخدم الحالي
                if (isLoggedIn) {
                    setOwnProfileMode(userData);
                    const posts = await loadUserPosts(userData.id);
                    postsCount.textContent = posts.length;
                    displayPosts(posts);
                } else {
                    setGuestMode();
                }
            } else {
                // عرض الملف الشخصي للمستخدم المحدد
                const profileData = await loadUserData(userId);
                
                if (profileData) {
                    if (isLoggedIn && userData.id === userId) {
                        // عرض الملف الشخصي الخاص
                        setOwnProfileMode(profileData);
                    } else {
                        // عرض الملف الشخصي لشخص آخر
                        setOtherProfileMode(profileData);
                    }
                    
                    const posts = await loadUserPosts(userId);
                    postsCount.textContent = posts.length;
                    displayPosts(posts);
                } else {
                    showNotification('المستخدم غير موجود', 'error');
                    setGuestMode();
                }
            }
        });
    </script>
</body>
</html>