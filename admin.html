<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إدارة المستخدمين - أيين</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base & Background Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Tajawal', sans-serif; min-height: 100vh; overflow-x: hidden; position: relative; background-color: #f5f5f5; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: -2; }
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .particle { position: absolute; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; animation: float 15s infinite linear; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes float { 0% { transform: translateY(100vh) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(100px); opacity: 0; } }

        /* --- Main Layout --- */
        main { padding: 10px 5px; min-height: 100vh; }
        .page-header { text-align: center; margin-bottom: 15px; }
        .page-header h1 { font-size: 1.5rem; color: rgba(255, 255, 255, 0.9); font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* --- Counters Section --- */
        .counters-section {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        .counter-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            min-width: 80px;
            transition: transform 0.3s ease;
        }
        .counter-card:hover {
            transform: translateY(-3px);
        }
        .counter-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a2a6c;
        }
        .counter-label {
            font-size: 0.7rem;
            color: #666;
            margin-top: 3px;
        }
        .counter-card.users { border-right: 3px solid #1a2a6c; }
        .counter-card.active { border-right: 3px solid #28a745; }
        .counter-card.review { border-right: 3px solid #ff9800; }
        .counter-card.rejected { border-right: 3px solid #dc3545; }

        /* --- Users List View --- */
        #usersListView { display: block; }
        .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .user-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        .user-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); border-color: #1a2a6c; }
        .user-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #1a2a6c, #b21f1f); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; font-weight: 700; }
        .user-card-info h3 { font-size: 1rem; color: #1a2a6c; margin-bottom: 4px; }
        .user-card-info p { font-size: 0.85rem; color: #666; }
        .user-card-footer { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; font-size: 0.8rem; color: #555; display: flex; justify-content: space-between; }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Notification Details */
        .notification-details {
            position: absolute;
            top: 35px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 10;
            max-width: 180px;
            display: none;
        }
        .notification-details.show { display: block; }
        .notification-details .notification-item {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .notification-details .notification-item:last-child { margin-bottom: 0; }
        .notification-details .notification-item i { 
            font-size: 0.7rem; 
            color: #ffc107;
        }

        /* --- User Detail View --- */
        #userDetailView { display: none; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .detail-header h2 { font-size: 1.3rem; color: rgba(255, 255, 255, 0.9); }
        .back-btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; }
        .back-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateX(-3px); }
        
        .detail-content { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .info-section, .posts-section { background: rgba(214, 184, 184, 0.95); border-radius: 12px; padding: 15px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12); }
        .section-title { font-size: 1.1rem; color: #1a2a6c; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #1a2a6c; }
        .info-grid { display: grid; gap: 10px; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .info-item strong { color: #333; font-weight: 600; font-size: 0.9rem; }
        .info-item span { color: #555; text-align: left; font-size: 0.85rem; }
        .action-buttons { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 6px 10px; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-view { background: #17a2b8; color: white; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-map { background: #007bff; color: white; }
        .btn:hover { transform: scale(1.05); opacity: 0.9; }

        .posts-grid { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 8px; }
        .post-summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            border-right: 3px solid #1a2a6c;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        .post-summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .post-summary-card.expiring { border-right: 3px solid #dc3545; background: #fff5f5; }
        .post-summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .post-summary-title { font-weight: 700; color: #1a2a6c; font-size: 0.9rem; }
        .post-summary-status { font-size: 0.75rem; padding: 3px 6px; border-radius: 10px; color: white; }
        .post-summary-status.active { background-color: #28a745; }
        .post-summary-status.review { background-color: #ff9800; }
        .post-summary-status.inactive { background-color: #f44336; }
        .post-summary-details { font-size: 0.8rem; color: #666; margin-bottom: 8px; }
        .post-timer { 
            background: #e9ecef; 
            padding: 6px; 
            border-radius: 5px; 
            text-align: center; 
            margin: 6px 0; 
            font-family: monospace; 
            font-weight: bold; 
            font-size: 0.8rem;
        }
        .post-timer.expiring { background: #f8d7da; color: #721c24; }
        .post-summary-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .post-summary-actions button { font-size: 0.75rem; padding: 5px 8px; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; padding: 10px; }
        .modal-content { background: white; border-radius: 12px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); overflow: hidden; max-width: 95%; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #1a2a6c, #2a3f8f); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.1rem; font-weight: 700; }
        .close-modal { background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer; }
        .modal-body { padding: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: 'Tajawal', sans-serif; font-size: 0.85rem; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #1a2a6c; outline: none; }
        .modal-actions { padding: 12px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-actions .btn { padding: 8px 12px; }

        /* Post Details Modal Styles */
        .post-images-container { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding: 8px 0; }
        .post-image { width: 120px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0; cursor: pointer; transition: transform 0.3s; }
        .post-image:hover { transform: scale(1.05); }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .detail-item { padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; }
        .detail-item.full-width { grid-column: 1 / -1; }
        .request-section { background: #fff3cd; padding: 12px; border-radius: 6px; margin: 8px 0; border-right: 3px solid #ffc107; }
        
        /* Map Modal */
        .map-modal-body { padding: 0; height: 60vh; }
        #mapContainer { width: 100%; height: 100%; }
        
        /* Image Preview Modal */
        .image-preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 3000; justify-content: center; align-items: center; }
        .image-preview-container { max-width: 90%; max-height: 90%; position: relative; }
        .image-preview-container img { max-width: 100%; max-height: 100%; border-radius: 6px; }
        .close-image-preview { position: absolute; top: -35px; right: 0; background: rgba(255, 255, 255, 0.2); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; }
        
        /* --- Notification Styles --- */
        .notification-container { position: fixed; top: 15px; right: 15px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
        .notification { background-color: white; border-radius: 8px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); padding: 12px 15px; display: flex; align-items: center; gap: 12px; min-width: 250px; transform: translateX(120%); opacity: 0; transition: all 0.4s ease; }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.success { border-right: 4px solid #4CAF50; }
        .notification.error { border-right: 4px solid #f44336; }
        .notification.info { border-right: 4px solid #2196F3; }
        .notification-icon { font-size: 1.3rem; }
        .notification.success .notification-icon { color: #4CAF50; }
        .notification.error .notification-icon { color: #f44336; }
        .notification.info .notification-icon { color: #2196F3; }
        .notification-content { flex-grow: 1; }
        .notification-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
        .notification-message { font-size: 0.8rem; color: #666; }

        /* --- Responsive Design --- */
        @media (max-width: 968px) {
            .detail-content { grid-template-columns: 1fr; }
            .details-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            main { padding: 8px 3px; }
            .page-header h1, .detail-header h2 { font-size: 1.3rem; }
            .users-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 8px; }
            .post-summary-actions { flex-direction: column; }
            .counters-section { gap: 3px; }
            .counter-card { min-width: 70px; padding: 6px 8px; }
            .counter-number { font-size: 1rem; }
            .counter-label { font-size: 0.65rem; }
        }

        /* تصميم العداد التنازلي */
        .countdown-container {
            margin: 8px 0;
            text-align: center;
        }

        .countdown {
            background: linear-gradient(135deg, #1a2a6c, #2a3f8f);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            box-shadow: 0 3px 8px rgba(26, 42, 108, 0.3);
        }

        .countdown-warning {
            background: linear-gradient(135deg, #ff5252, #ff1744);
            color: white;
            padding: 8px 10px;
            border-radius: 8px;
            margin-top: 6px;
            font-size: 0.75rem;
            line-height: 1.3;
            box-shadow: 0 3px 8px rgba(255, 23, 68, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .countdown-warning i {
            font-size: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Request Actions */
        .request-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .request-actions button {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .request-actions .btn-clear-reject {
            background-color: #dc3545;
            color: white;
        }
        .request-actions .btn-clear-edit {
            background-color: #ffc107;
            color: #333;
        }
        .request-actions button:hover {
            opacity: 0.8;
        }
        
        /* Payment Section */
        .payment-section {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-right: 3px solid #4CAF50;
        }
        .payment-section h3 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .payment-content {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .payment-image-container {
            flex: 0 0 120px;
        }
        .payment-image-container img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #4CAF50;
        }
        .payment-text {
            flex: 1;
            color: #2e7d32;
            font-size: 0.85rem;
            line-height: 1.4;
        }

/* Notification Area Styles */
.notification-area {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    min-height: 25px;
}

.notification-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 3px 6px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.notification-item.active {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.notification-item.edit {
    background: linear-gradient(135deg, #ffc107, #ff9800);
}

.notification-item.delete {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.notification-item i {
    font-size: 0.65rem;
}

.notification-item .count {
    background: rgba(255, 255, 255, 0.3);
    padding: 1px 4px;
    border-radius: 8px;
    margin-right: 2px;
}

    </style>
</head>
<body>
    <div class="background"></div>
    <div class="particles" id="particles"></div>

    <main>
        <!-- Users List View -->
        <div id="usersListView">
            <div class="page-header">
                <h1>إدارة المستخدمين</h1>
            </div>
            
            <!-- Counters Section -->
            <div class="counters-section">
                <div class="counter-card users">
                    <div class="counter-number" id="usersCounter">0</div>
                    <div class="counter-label">المستخدمون</div>
                </div>
                <div class="counter-card active">
                    <div class="counter-number" id="activePostsCounter">0</div>
                    <div class="counter-label">منشورات نشطة</div>
                </div>
                <div class="counter-card review">
                    <div class="counter-number" id="reviewPostsCounter">0</div>
                    <div class="counter-label">قيد المراجعة</div>
                </div>
                <div class="counter-card rejected">
                    <div class="counter-number" id="rejectedPostsCounter">0</div>
                    <div class="counter-label">مرفوضة</div>
                </div>
            </div>
            
            <div class="users-grid" id="usersContainer">
                <!-- Users will be loaded here -->
            </div>
        </div>

        <!-- User Detail View -->
        <div id="userDetailView">
            <div class="detail-header">
                <h2 id="detailUserName">اسم المستخدم</h2>
                <button class="back-btn" onclick="showUsersList()">
                    <i class="fas fa-arrow-right"></i>
                    الرجوع للمستخدمين
                </button>
            </div>
            <div class="detail-content">
                <div class="info-section">
                    <h3 class="section-title">البيانات التعريفية</h3>
                    <div class="info-grid" id="userInfoContainer">
                        <!-- User info will be loaded here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-edit" onclick="openEditUserModal()"><i class="fas fa-edit"></i> تعديل المستخدم</button>
                        <button class="btn btn-delete" onclick="confirmDeleteUser()"><i class="fas fa-trash"></i> حذف المستخدم</button>
                    </div>
                </div>
                <div class="posts-section">
                    <h3 class="section-title">منشورات المستخدم</h3>
                    <div class="posts-grid" id="userPostsContainer">
                        <!-- User posts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعديل بيانات المستخدم</h2>
                <button class="close-modal" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label for="editFullName">الاسم الكامل</label>
                        <input type="text" id="editFullName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthDate">تاريخ الميلاد</label>
                        <input type="date" id="editBirthDate">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">العنوان</label>
                        <textarea id="editAddress" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editPhone1">رقم الهاتف 1</label>
                        <input type="tel" id="editPhone1" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone2">رقم الهاتف 2</label>
                        <input type="tel" id="editPhone2">
                    </div>
                    <div class="form-group">
                        <label for="editCompanyName">اسم الشركة</label>
                        <input type="text" id="editCompanyName">
                    </div>
                    <div class="form-group">
                        <label for="editPassword">كلمة المرور</label>
                        <input type="password" id="editPassword">
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-edit" onclick="saveUserChanges()"><i class="fas fa-save"></i> حفظ التغييرات</button>
                <button class="btn" style="background:#6c757d; color:white;" onclick="closeEditUserModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تأكيد الحذف</h2>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">هل أنت متأكد من أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-delete" id="confirmDeleteBtn"><i class="fas fa-trash"></i> حذف</button>
                <button class="btn" style="background:#6c757d; color:white;" onclick="closeDeleteModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Post Details Modal -->
    <div id="postDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تفاصيل المنشور</h2>
                <button class="close-modal" onclick="closePostDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="postDetailsBody">
                <!-- Post details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95%;">
            <div class="modal-header">
                <h2>الموقع على الخريطة</h2>
                <button class="close-modal" onclick="closeMapModal()">&times;</button>
            </div>
            <div class="map-modal-body">
                <div id="mapContainer"></div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-container">
            <button class="close-image-preview" onclick="closeImagePreview()">&times;</button>
            <img id="previewImage" src="" alt="معاينة الصورة">
        </div>
    </div>

    <!-- Reject Post Modal -->
    <div id="rejectPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>رفض المنشور</h2>
                <button class="close-modal" onclick="closeRejectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="rejectReason">سبب الرفض</label>
                    <textarea id="rejectReason" rows="5" placeholder="أدخل سبب رفض المنشور..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-reject" onclick="submitRejection()"><i class="fas fa-times"></i> إرسال الرفض</button>
                <button class="btn" style="background:#6c757d; color:white;" onclick="closeRejectModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعديل المنشور</h2>
                <button class="close-modal" onclick="closeEditPostModal()">&times;</button>
            </div>
            <div class="modal-body" id="editPostBody">
                <!-- Edit post form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // --- Supabase Setup ---
        const { createClient } = supabase;
        const supabaseUrl = 'https://rastimuoifacxcitljdw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhc3RpbXVvaWZhY3hjaXRsamR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzODYxOTIsImV4cCI6MjA3NTk2MjE5Mn0.xOW2p17zvHy9z8n4q-T__jgiNE83N927oRs2Max13RQ';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // --- Global Variables ---
        let currentUserId = null;
        let currentDeleteAction = null; // 'user' or 'post'
        let currentDeleteId = null;
        let currentPostId = null;
        let postTimers = {};
        let map = null;
        let mapMarker = null;

        // --- DOM Elements ---
        const usersListView = document.getElementById('usersListView');
        const userDetailView = document.getElementById('userDetailView');
        const usersContainer = document.getElementById('usersContainer');
        const userInfoContainer = document.getElementById('userInfoContainer');
        const userPostsContainer = document.getElementById('userPostsContainer');
        const detailUserName = document.getElementById('detailUserName');
        const editUserModal = document.getElementById('editUserModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const postDetailsModal = document.getElementById('postDetailsModal');
        const postDetailsBody = document.getElementById('postDetailsBody');
        const rejectPostModal = document.getElementById('rejectPostModal');
        const editPostModal = document.getElementById('editPostModal');
        const editPostBody = document.getElementById('editPostBody');
        const mapModal = document.getElementById('mapModal');
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');

        // --- Counters ---
        const usersCounter = document.getElementById('usersCounter');
        const activePostsCounter = document.getElementById('activePostsCounter');
        const reviewPostsCounter = document.getElementById('reviewPostsCounter');
        const rejectedPostsCounter = document.getElementById('rejectedPostsCounter');

        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            loadUsers();
            loadCounters();
            // التحقق من المشاركات المنتهية صلاحيتها كل دقيقة
            setInterval(checkExpiredPosts, 60000);
        });

        // --- Particle Background ---
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) { // تقليل عدد الجسيمات لتحسين الأداء على الهواتف
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 15 + 's';
                p.style.animationDuration = (Math.random() * 10 + 15) + 's';
                container.appendChild(p);
            }
        }

        // --- Notification System ---
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';

            notification.innerHTML = `
                <div class="notification-icon"><i class="fas ${icon}"></i></div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 400); }, 4000);
        }

        // --- View Management ---
        function showUsersList() {
            usersListView.style.display = 'block';
            userDetailView.style.display = 'none';
            // Clear all timers when leaving detail view
            Object.keys(postTimers).forEach(timerId => {
                clearInterval(postTimers[timerId]);
            });
            postTimers = {};
        }

        function showUserDetail(userId) {
            currentUserId = userId;
            usersListView.style.display = 'none';
            userDetailView.style.display = 'block';
            loadUserDetail(userId);
        }

        // --- Data Loading ---
        async function loadUsers() {
            try {
                const { data: users, error } = await supabaseClient.from('users').select('*');
                if (error) throw error;
                
                // Load notifications for each user
                const usersWithNotifications = await Promise.all(users.map(async (user) => {
                    const notifications = await getUserNotifications(user.id);
                    return { ...user, notifications };
                }));
                
                // Sort users by notifications (users with notifications first) and then by creation date
                usersWithNotifications.sort((a, b) => {
                    // First sort by whether they have notifications
                    if (a.notifications.hasNotifications && !b.notifications.hasNotifications) return -1;
                    if (!a.notifications.hasNotifications && b.notifications.hasNotifications) return 1;
                    
                    // Then sort by creation date (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                displayUsersList(usersWithNotifications);
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('خطأ', 'فشل تحميل قائمة المستخدمين', 'error');
            }
        }

        // Load counters
        async function loadCounters() {
            try {
                // Count users
                const { count: usersCount, error: usersError } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (usersError) throw usersError;
                usersCounter.textContent = usersCount || 0;
                
                // Count active posts
                const { count: activeCount, error: activeError } = await supabaseClient
                    .from('msg3')
                    .select('*', { count: 'exact', head: true })
                    .like('post_status', '%نشط%');
                
                if (activeError) throw activeError;
                activePostsCounter.textContent = activeCount || 0;
                
                // Count review posts
                const { count: reviewCount, error: reviewError } = await supabaseClient
                    .from('msg3')
                    .select('*', { count: 'exact', head: true })
                    .like('post_status', '%مراجعة%');
                
                if (reviewError) throw reviewError;
                reviewPostsCounter.textContent = reviewCount || 0;
                
                // Count rejected posts
                const { count: rejectedCount, error: rejectedError } = await supabaseClient
                    .from('msg3')
                    .select('*', { count: 'exact', head: true })
                    .like('post_status', '%مرفوض%');
                
                if (rejectedError) throw rejectedError;
                rejectedPostsCounter.textContent = rejectedCount || 0;
                
            } catch (error) {
                console.error('Error loading counters:', error);
            }
        }

        // Get user notifications details
        async function getUserNotifications(userId) {
            try {
                // Get posts under review
                const { data: reviewPosts, error: reviewError } = await supabaseClient
                    .from('msg3')
                    .select('*')
                    .eq('user_id', userId)
                    .like('post_status', '%مراجعة%');
                
                if (reviewError) throw reviewError;
                
                // Get posts with edit requests
                const { data: editPosts, error: editError } = await supabaseClient
                    .from('msg3')
                    .select('*')
                    .eq('user_id', userId)
                    .not('edat', 'is', null);
                
                if (editError) throw editError;
                
                // Get posts with delete requests
                const { data: deletePosts, error: deleteError } = await supabaseClient
                    .from('msg3')
                    .select('*')
                    .eq('user_id', userId)
                    .not('rejct', 'is', null);
                
                if (deleteError) throw deleteError;
                
                // Get active posts
                const { data: activePosts, error: activeError } = await supabaseClient
                    .from('msg3')
                    .select('*')
                    .eq('user_id', userId)
                    .like('post_status', '%نشط%');
                
                if (activeError) throw activeError;
                
                return {
                    hasNotifications: reviewPosts.length > 0 || editPosts.length > 0 || deletePosts.length > 0,
                    activeCount: activePosts.length,
                    reviewCount: reviewPosts.length,
                    editCount: editPosts.length,
                    deleteCount: deletePosts.length,
                    details: {
                        active: activePosts.length > 0 ? `مشاركة جديدة (${activePosts.length})` : null,
                        edit: editPosts.length > 0 ? 'طلب تعديل' : null,
                        delete: deletePosts.length > 0 ? 'طلب حذف' : null
                    }
                };
            } catch (error) {
                console.error('Error getting user notifications:', error);
                return {
                    hasNotifications: false,
                    activeCount: 0,
                    reviewCount: 0,
                    editCount: 0,
                    deleteCount: 0,
                    details: {}
                };
            }
        }

        function displayUsersList(users) {
            usersContainer.innerHTML = '';
            if (users.length === 0) {
                usersContainer.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">لا يوجد مستخدمون لعرضهم.</p>';
                return;
            }
            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => showUserDetail(user.id);
                
                const initials = user.full_name ? user.full_name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                const companyName = user.company_name || 'شخصي';
                
                // Create notification items
                let notificationItems = '';
                if (user.notifications.hasNotifications) {
                    const items = [];
                    
                    if (user.notifications.details.active) {
                        items.push(`
                            <div class="notification-item active">
                                <i class="fas fa-bell"></i>
                                <span>مشاركة جديدة</span>
                                <span class="count">${user.notifications.activeCount}</span>
                            </div>
                        `);
                    }
                    
                    if (user.notifications.details.edit) {
                        items.push(`
                            <div class="notification-item edit">
                                <i class="fas fa-edit"></i>
                                <span>طلب تعديل</span>
                            </div>
                        `);
                    }
                    
                    if (user.notifications.details.delete) {
                        items.push(`
                            <div class="notification-item delete">
                                <i class="fas fa-trash"></i>
                                <span>طلب حذف</span>
                            </div>
                        `);
                    }
                    
                    notificationItems = `<div class="notification-area">${items.join('')}</div>`;
                }
                
                card.innerHTML = `
                    <div class="user-card-header">
                        <div class="user-avatar">${initials}</div>
                        <div class="user-card-info">
                            <h3>${user.full_name || 'اسم غير محدد'}</h3>
                            <p>${companyName}</p>
                        </div>
                    </div>
                    <div class="user-card-footer">
                        <span><i class="fas fa-phone"></i> ${user.phone1 || '---'}</span>
                        <span><i class="fas fa-calendar"></i> ${new Date(user.created_at).toLocaleDateString('ar-IQ')}</span>
                    </div>
                    ${notificationItems}
                `;
                
                usersContainer.appendChild(card);
            });
        }

        async function loadUserDetail(userId) {
            try {
                // Load user info
                const { data: user, error: userError } = await supabaseClient.from('users').select('*').eq('id', userId).single();
                if (userError) throw userError;
                displayUserInfo(user);
                detailUserName.textContent = user.full_name || 'مستخدم غير معروف';

                // Load user posts from msg3
                const { data: posts, error: postsError } = await supabaseClient.from('msg3').select('*').eq('user_id', userId);
                if (postsError) throw postsError;
                displayUserPosts(posts);

            } catch (error) {
                console.error('Error loading user detail:', error);
                showNotification('خطأ', 'فشل تحميل بيانات المستخدم', 'error');
            }
        }

        function displayUserInfo(user) {
            userInfoContainer.innerHTML = `
                <div class="info-item"><strong>الاسم الكامل:</strong> <span>${user.full_name || '---'}</span></div>
                <div class="info-item"><strong>تاريخ الميلاد:</strong> <span>${user.birth_date ? new Date(user.birth_date).toLocaleDateString('ar-IQ') : '---'}</span></div>
                <div class="info-item"><strong>العنوان:</strong> <span>${user.address || '---'}</span></div>
                <div class="info-item"><strong>الهاتف 1:</strong> <span>${user.phone1 || '---'}</span></div>
                <div class="info-item"><strong>الهاتف 2:</strong> <span>${user.phone2 || '---'}</span></div>
                <div class="info-item"><strong>اسم الشركة:</strong> <span>${user.company_name || '---'}</span></div>
                <div class="info-item"><strong>كلمة المرور:</strong> <span>${user.password || '---'}</span></div>
                <div class="info-item"><strong>تاريخ الإنشاء:</strong> <span>${new Date(user.created_at).toLocaleDateString('ar-IQ')}</span></div>
            `;
        }

        function displayUserPosts(posts) {
            userPostsContainer.innerHTML = '';
            if (posts.length === 0) {
                userPostsContainer.innerHTML = '<p style="text-align: center; color: #999;">لا يوجد منشورات لهذا المستخدم في جدول msg3.</p>';
                return;
            }
            
            // Clear previous timers
            Object.keys(postTimers).forEach(timerId => {
                clearInterval(postTimers[timerId]);
            });
            postTimers = {};

            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'post-summary-card';
                card.id = `post-${post.id}`;
                
                const status = post.post_status || 'غير محدد';
                let statusClass = 'inactive';
                if (status.includes('نشط')) statusClass = 'active';
                if (status.includes('مراجعة')) statusClass = 'review';

                // Calculate timer if post is active
                let timerHTML = '';
                let shouldStartTimer = false; // Use a flag to check if we need to start the timer
                if (status.includes('نشط') && post.adad) {
                    shouldStartTimer = true;
                    timerHTML = `
                        <div class="countdown-container">
                            <div class="countdown" id="timer-${post.id}" data-end-time="${post.adad}"></div>
                            <div class="countdown-warning" id="warning-${post.id}" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                صلاحية عرض الإعلان قريبة من الانتهاء سوف يتم حذف هذه المشاركة قريبا يمكنك انشاء مشاركة جديدة شكرا لاختياركم أيين
                            </div>
                        </div>
                    `;
                }

                // Create request actions if there are edit/delete requests
                let requestActionsHTML = '';
                if (post.rejct) {
                    requestActionsHTML += `
                        <div class="request-section">
                            <h4><i class="fas fa-trash"></i> طلب الحذف</h4>
                            <p>${post.rejct}</p>
                            <div class="request-actions">
                                <button class="btn-clear-reject" onclick="clearRejectRequest('${post.id}')">
                                    <i class="fas fa-trash"></i> حذف الطلب
                                </button>
                            </div>
                        </div>
                    `;
                }
                if (post.edat) {
                    requestActionsHTML += `
                        <div class="request-section">
                            <h4><i class="fas fa-edit"></i> طلب التعديل</h4>
                            <p>${post.edat}</p>
                            <div class="request-actions">
                                <button class="btn-clear-edit" onclick="clearEditRequest('${post.id}')">
                                    <i class="fas fa-trash"></i> حذف الطلب
                                </button>
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    ${timerHTML}
                    <div class="post-summary-header">
                        <span class="post-summary-title">${post.offer_type} ${post.property_type}</span>
                        <span class="post-summary-status ${statusClass}">${status}</span>
                    </div>
                    <div class="post-summary-details">
                        <p><strong>المحافظة:</strong> ${post.governorate || '---'}</p>
                        <p><strong>السعر:</strong> ${post.price ? `${parseInt(post.price).toLocaleString('ar-IQ')} ع.د` : '---'}</p>
                        <p><strong>كود المشاركة:</strong> ${post.post_code || '---'}</p>
                        ${post.payment_duration ? `<p><strong>مدة النشر:</strong> ${post.payment_duration} يوم</p>` : ''}
                    </div>
                    ${requestActionsHTML}
                    <div class="post-summary-actions">
                        <button class="btn btn-view" onclick="viewPostDetails('${post.id}')"><i class="fas fa-eye"></i> عرض التفاصيل</button>
                        ${status.includes('مراجعة') ? `
                            <button class="btn btn-approve" onclick="approvePost('${post.id}')"><i class="fas fa-check"></i> موافقة</button>
                            <button class="btn btn-reject" onclick="openRejectModal('${post.id}')"><i class="fas fa-times"></i> رفض</button>
                        ` : ''}
                        <button class="btn btn-edit" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-delete" onclick="confirmDeletePost('${post.id}')"><i class="fas fa-trash"></i> حذف المنشور</button>
                    </div>
                `;
                
                // *** التغيير الرئيسي هنا ***
                // أولاً، أضف البطاقة إلى الصفحة
                userPostsContainer.appendChild(card);
                
                // ثانياً، بعد إضافتها، ابدأ العداد إذا كان مطلوباً
                if (shouldStartTimer) {
                    startPostTimer(post.id, post.adad);
                }
            });
        }
        
        // --- Timer Functions ---
        function startPostTimer(postId, endTime) {
            const timerElement = document.getElementById(`timer-${postId}`);
            const warningElement = document.getElementById(`warning-${postId}`);
            const postCard = document.getElementById(`post-${postId}`);
            
            function updateTimer() {
                const now = new Date();
                const end = new Date(endTime);
                const diff = end - now;
                
                if (diff <= 0) {
                    timerElement.innerHTML = 'انتهت صلاحية العرض';
                    clearInterval(postTimers[postId]);
                    // Auto delete post after expiration
                    setTimeout(() => deleteExpiredPost(postId), 5000);
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                timerElement.innerHTML = `${days} يوم : ${hours} ساعة : ${minutes} دقيقة : ${seconds} ثانية`;
                
                // Show warning if less than 24 hours remaining
                if (diff < 24 * 60 * 60 * 1000) {
                    warningElement.style.display = 'flex';
                    postCard.classList.add('expiring');
                }
            }
            
            updateTimer();
            postTimers[postId] = setInterval(updateTimer, 1000);
        }

        async function deleteExpiredPost(postId) {
            try {
                // جلب بيانات المنشور قبل حذفه
                const { data: post, error: fetchError } = await supabaseClient
                    .from('msg3')
                    .select('images, payment_image_url')
                    .eq('id', postId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // حذف المنشور
                const { error: deleteError } = await supabaseClient
                    .from('msg3')
                    .delete()
                    .eq('id', postId);
                
                if (deleteError) throw deleteError;
                
                // حذف الصور المرتبطة بالمنشور
                if (post.images && post.images.length > 0) {
                    for (const imageUrl of post.images) {
                        try {
                            const parts = imageUrl.split('/');
                            const bucketIndex = parts.findIndex(part => part === 'property-images');
                            if (bucketIndex !== -1) {
                                const filePath = parts.slice(bucketIndex + 1).join('/');
                                await supabaseClient.storage.from('property-images').remove([filePath]);
                            }
                        } catch (err) {
                            // تجاهل أخطاء حذف الصور
                        }
                    }
                }
                
                // حذف صورة إثبات الدفع إذا وجدت
                if (post.payment_image_url) {
                    try {
                        const parts = post.payment_image_url.split('/');
                        const bucketIndex = parts.findIndex(part => part === 'payment-proofs');
                        if (bucketIndex !== -1) {
                            const filePath = parts.slice(bucketIndex + 1).join('/');
                            await supabaseClient.storage.from('payment-proofs').remove([filePath]);
                        }
                    } catch (err) {
                        // تجاهل أخطاء حذف صورة الدفع
                    }
                }
                
                showNotification('معلومات', 'تم حذف المنشور تلقائياً بعد انتهاء صلاحيته', 'info');
                loadUserDetail(currentUserId);
                loadCounters(); // Update counters
            } catch (error) {
                console.error('Error deleting expired post:', error);
            }
        }

        // دالة للتحقق من المشاركات المنتهية صلاحيتها وحذفها
        async function checkExpiredPosts() {
            try {
                const now = new Date().toISOString();
                
                // جلب المشاركات المنتهية صلاحيتها
                const { data: expiredPosts, error } = await supabaseClient
                    .from('msg3')
                    .select('id, images, payment_image_url')
                    .eq('post_status', 'الإعلان نشط الان')
                    .lt('adad', now);
                
                if (error) throw error;
                
                // حذف كل مشاركة منتهية الصلاحية
                for (const post of expiredPosts) {
                    await deleteExpiredPost(post.id);
                }
                
            } catch (error) {
                console.error('Error checking expired posts:', error);
            }
        }

        // --- Map Function ---
        function openLocationOnMap(location) {
            if (!location) {
                showNotification('خطأ', 'لا توجد إحداثيات متاحة لهذا الموقع', 'error');
                return;
            }
            
            // Parse coordinates
            const [lat, lng] = location.split(',').map(coord => parseFloat(coord.trim()));
            if (isNaN(lat) || isNaN(lng)) {
                showNotification('خطأ', 'تنسيق الإحداثيات غير صحيح', 'error');
                return;
            }
            
            // Show map modal
            mapModal.style.display = 'flex';
            
            // Initialize map after modal is shown
            setTimeout(() => {
                // Initialize map if not already created
                if (!map) {
                    map = L.map('mapContainer').setView([lat, lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                } else {
                    // Clear existing marker
                    if (mapMarker) {
                        map.removeLayer(mapMarker);
                    }
                    // Set view to new location
                    map.setView([lat, lng], 15);
                }
                
                // Add marker for the location
                mapMarker = L.marker([lat, lng]).addTo(map);
            }, 100);
        }

        function closeMapModal() {
            mapModal.style.display = 'none';
        }

        // --- Image Preview Function ---
        function openImagePreview(imageSrc) {
            previewImage.src = imageSrc;
            imagePreviewModal.style.display = 'flex';
        }

        function closeImagePreview() {
            imagePreviewModal.style.display = 'none';
        }

        // --- Request Management Functions ---
        async function clearRejectRequest(postId) {
            try {
                const { error } = await supabaseClient
                    .from('msg3')
                    .update({ rejct: null })
                    .eq('id', postId);
                
                if (error) throw error;
                showNotification('نجاح', 'تم حذف طلب الحذف بنجاح', 'success');
                loadUserDetail(currentUserId);
            } catch (error) {
                console.error('Error clearing reject request:', error);
                showNotification('خطأ', 'فشل حذف طلب الحذف', 'error');
            }
        }

        async function clearEditRequest(postId) {
            try {
                const { error } = await supabaseClient
                    .from('msg3')
                    .update({ edat: null })
                    .eq('id', postId);
                
                if (error) throw error;
                showNotification('نجاح', 'تم حذف طلب التعديل بنجاح', 'success');
                loadUserDetail(currentUserId);
            } catch (error) {
                console.error('Error clearing edit request:', error);
                showNotification('خطأ', 'فشل حذف طلب التعديل', 'error');
            }
        }

        // --- Post Management Functions ---

        // VIEW POST DETAILS
        async function viewPostDetails(postId) {
            try {
                const { data: post, error } = await supabaseClient.from('msg3').select('*').eq('id', postId).single();
                if (error) throw error;

                let imagesHTML = '';
                if (post.images && post.images.length > 0) {
                    imagesHTML = `
                        <h3>صور المنشور</h3>
                        <div class="post-images-container">
                            ${post.images.map(img => `<img src="${img}" alt="صورة العقار" class="post-image" onclick="openImagePreview('${img}')">`).join('')}
                        </div>
                    `;
                }

                let paymentHTML = '';
                if (post.payment_image_url || post.payment_text) {
                    let paymentImageHTML = '';
                    if (post.payment_image_url) {
                        paymentImageHTML = `
                            <div class="payment-image-container">
                                <img src="${post.payment_image_url}" alt="صورة إثبات الدفع" onclick="openImagePreview('${post.payment_image_url}')">
                            </div>
                        `;
                    }
                    
                    let paymentTextHTML = '';
                    if (post.payment_text) {
                        paymentTextHTML = `<div class="payment-text">${post.payment_text}</div>`;
                    }
                    
                    paymentHTML = `
                        <div class="payment-section">
                            <h3>معلومات الدفع</h3>
                            <div class="payment-content">
                                ${paymentImageHTML}
                                ${paymentTextHTML}
                            </div>
                        </div>
                    `;
                }

                // Add map link if location exists
                let locationHTML = '';
                if (post.location) {
                    locationHTML = `
                        <div class="detail-item full-width">
                            <strong>الموقع:</strong> 
                            <button class="btn btn-map" onclick="openLocationOnMap('${post.location}')">
                                <i class="fas fa-map-marked-alt"></i> عرض على الخريطة
                            </button>
                        </div>
                    `;
                } else {
                    locationHTML = `<div class="detail-item full-width"><strong>الموقع:</strong> ---</div>`;
                }

                postDetailsBody.innerHTML = `
                    ${imagesHTML}
                    ${paymentHTML}
                    <div class="details-grid">
                        <div class="detail-item">
                            <strong>نوع العرض:</strong> ${post.offer_type}
                        </div>
                        <div class="detail-item">
                            <strong>نوع العقار:</strong> ${post.property_type}
                        </div>
                        <div class="detail-item">
                            <strong>رقم العقار:</strong> ${post.property_number || '---'}
                        </div>
                        <div class="detail-item">
                            <strong>نوع الصك:</strong> ${post.deed_type || '---'}
                        </div>
                        <div class="detail-item">
                            <strong>المساحة:</strong> ${post.area_number} ${post.area_unit}
                        </div>
                        <div class="detail-item">
                            <strong>حالة العقار:</strong> ${post.property_condition}
                        </div>
                        <div class="detail-item full-width">
                            <strong>المميزات:</strong> ${post.features || '---'}
                        </div>
                        <div class="detail-item full-width">
                            <strong>ملاحظات:</strong> ${post.notes || '---'}
                        </div>
                        <div class="detail-item">
                            <strong>السعر:</strong> ${post.price ? `${parseInt(post.price).toLocaleString('ar-IQ')} ع.د` : '---'}
                        </div>
                        <div class="detail-item">
                            <strong>قابلية التفاوض:</strong> ${post.price_negotiable}
                        </div>
                        <div class="detail-item">
                            <strong>المحافظة:</strong> ${post.governorate}
                        </div>
                        <div class="detail-item">
                            <strong>العنوان الدقيق:</strong> ${post.precise_address}
                        </div>
                        ${locationHTML}
                        <div class="detail-item">
                            <strong>اسم المعلن:</strong> ${post.advertiser_name}
                        </div>
                        <div class="detail-item">
                            <strong>هاتف المعلن:</strong> ${post.advertiser_phone}
                        </div>
                        <div class="detail-item">
                            <strong>اسم الشركة:</strong> ${post.company_name || '---'}
                        </div>
                        <div class="detail-item">
                            <strong>حالة المنشور:</strong> ${post.post_status}
                        </div>
                        <div class="detail-item">
                            <strong>كود المشاركة:</strong> ${post.post_code || '---'}
                        </div>
                    </div>
                `;

                postDetailsModal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading post details:', error);
                showNotification('خطأ', 'فشل تحميل تفاصيل المنشور', 'error');
            }
        }

        function closePostDetailsModal() {
            postDetailsModal.style.display = 'none';
        }

        // APPROVE POST
        async function approvePost(postId) {
            try {
                const { data: post, error: fetchError } = await supabaseClient.from('msg3').select('payment_duration').eq('id', postId).single();
                if (fetchError) throw fetchError;

                const duration = post.payment_duration || 30;
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + duration);

                const { error } = await supabaseClient.from('msg3').update({
                    post_status: 'الإعلان نشط الآن',
                    adad: endDate.toISOString() // حفظ وقت انتهاء الصلاحية
                }).eq('id', postId);

                if (error) throw error;
                showNotification('نجاح', 'تم تفعيل المنشور بنجاح', 'success');
                loadUserDetail(currentUserId);
                loadCounters(); // Update counters
            } catch (error) {
                console.error('Error approving post:', error);
                showNotification('خطأ', 'فشل تفعيل المنشور', 'error');
            }
        }

        // REJECT POST
        function openRejectModal(postId) {
            currentPostId = postId;
            rejectPostModal.style.display = 'flex';
        }

        function closeRejectModal() {
            rejectPostModal.style.display = 'none';
            document.getElementById('rejectReason').value = '';
        }

        async function submitRejection() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                showNotification('تحذير', 'يرجى إدخال سبب الرفض', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.from('msg3').update({
                    post_status: 'الإعلان مرفوض',
                    rejct1: reason
                }).eq('id', currentPostId);

                if (error) throw error;
                showNotification('نجاح', 'تم رفض المنشور بنجاح', 'success');
                closeRejectModal();
                loadUserDetail(currentUserId);
                loadCounters(); // Update counters
            } catch (error) {
                console.error('Error rejecting post:', error);
                showNotification('خطأ', 'فشل رفض المنشور', 'error');
            }
        }

        // EDIT POST
        async function openEditPostModal(postId) {
            currentPostId = postId;
            try {
                const { data: post, error } = await supabaseClient.from('msg3').select('*').eq('id', postId).single();
                if (error) throw error;

                editPostBody.innerHTML = `
                    <form id="editPostForm">
                        <div class="form-group">
                            <label for="editOfferType">نوع العرض</label>
                            <select id="editOfferType" required>
                                <option value="بيع" ${post.offer_type === 'بيع' ? 'selected' : ''}>بيع</option>
                                <option value="إيجار" ${post.offer_type === 'إيجار' ? 'selected' : ''}>إيجار</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPropertyType">نوع العقار</label>
                            <input type="text" id="editPropertyType" value="${post.property_type || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editPropertyNumber">رقم العقار</label>
                            <input type="text" id="editPropertyNumber" value="${post.property_number || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editDeedType">نوع الصك</label>
                            <input type="text" id="editDeedType" value="${post.deed_type || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editAreaNumber">المساحة</label>
                            <input type="number" id="editAreaNumber" value="${post.area_number || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editAreaUnit">وحدة المساحة</label>
                            <select id="editAreaUnit" required>
                                <option value="م²" ${post.area_unit === 'م²' ? 'selected' : ''}>متر مربع</option>
                                <option value="دونم" ${post.area_unit === 'دونم' ? 'selected' : ''}>دونم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPropertyCondition">حالة العقار</label>
                            <input type="text" id="editPropertyCondition" value="${post.property_condition || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editFeatures">المميزات</label>
                            <textarea id="editFeatures" rows="3">${post.features || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="editNotes">ملاحظات</label>
                            <textarea id="editNotes" rows="3">${post.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="editPrice">السعر</label>
                            <input type="number" id="editPrice" value="${post.price || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editPriceNegotiable">قابلية التفاوض</label>
                            <select id="editPriceNegotiable" required>
                                <option value="قابل للتفاوض" ${post.price_negotiable === 'قابل للتفاوض' ? 'selected' : ''}>قابل للتفاوض</option>
                                <option value="ثابت" ${post.price_negotiable === 'ثابت' ? 'selected' : ''}>ثابت</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editGovernorate">المحافظة</label>
                            <input type="text" id="editGovernorate" value="${post.governorate || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editPreciseAddress">العنوان الدقيق</label>
                            <textarea id="editPreciseAddress" rows="2" required>${post.precise_address || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="editLocation">الموقع (إحداثيات)</label>
                            <input type="text" id="editLocation" value="${post.location || ''}" placeholder="latitude,longitude">
                        </div>
                        <div class="form-group">
                            <label for="editAdvertiserName">اسم المعلن</label>
                            <input type="text" id="editAdvertiserName" value="${post.advertiser_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editAdvertiserPhone">هاتف المعلن</label>
                            <input type="tel" id="editAdvertiserPhone" value="${post.advertiser_phone || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editCompanyNamePost">اسم الشركة</label>
                            <input type="text" id="editCompanyNamePost" value="${post.company_name || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editPublishDuration">مدة النشر (أيام)</label>
                            <select id="editPublishDuration" required>
                                ${[30,60,90,120,150,180,210,240,270,300,330,360].map(days => 
                                    `<option value="${days}" ${post.publish_duration === days ? 'selected' : ''}>${days} يوم</option>`
                                ).join('')}
                            </select>
                        </div>
                    </form>
                    <div class="modal-actions">
                        <button class="btn btn-edit" onclick="savePostChanges()"><i class="fas fa-save"></i> حفظ التغييرات</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="closeEditPostModal()">إلغاء</button>
                    </div>
                `;

                editPostModal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading post for edit:', error);
                showNotification('خطأ', 'فشل تحميل بيانات المنشور للتعديل', 'error');
            }
        }

        function closeEditPostModal() {
            editPostModal.style.display = 'none';
        }

        async function savePostChanges() {
            const formData = {
                offer_type: document.getElementById('editOfferType').value,
                property_type: document.getElementById('editPropertyType').value,
                property_number: document.getElementById('editPropertyNumber').value,
                deed_type: document.getElementById('editDeedType').value,
                area_number: document.getElementById('editAreaNumber').value,
                area_unit: document.getElementById('editAreaUnit').value,
                property_condition: document.getElementById('editPropertyCondition').value,
                features: document.getElementById('editFeatures').value,
                notes: document.getElementById('editNotes').value,
                price: document.getElementById('editPrice').value,
                price_negotiable: document.getElementById('editPriceNegotiable').value,
                governorate: document.getElementById('editGovernorate').value,
                precise_address: document.getElementById('editPreciseAddress').value,
                location: document.getElementById('editLocation').value,
                advertiser_name: document.getElementById('editAdvertiserName').value,
                advertiser_phone: document.getElementById('editAdvertiserPhone').value,
                company_name: document.getElementById('editCompanyNamePost').value,
                publish_duration: document.getElementById('editPublishDuration').value,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabaseClient.from('msg3').update(formData).eq('id', currentPostId);
                if (error) throw error;
                showNotification('نجاح', 'تم تحديث المنشور بنجاح', 'success');
                closeEditPostModal();
                loadUserDetail(currentUserId);
            } catch (error) {
                console.error('Error updating post:', error);
                showNotification('خطأ', 'فشل تحديث المنشور', 'error');
            }
        }

        // EDIT USER
        async function openEditUserModal() {
            if (!currentUserId) return;
            try {
                const { data: user, error } = await supabaseClient.from('users').select('*').eq('id', currentUserId).single();
                if (error) throw error;

                document.getElementById('editFullName').value = user.full_name || '';
                document.getElementById('editBirthDate').value = user.birth_date || '';
                document.getElementById('editAddress').value = user.address || '';
                document.getElementById('editPhone1').value = user.phone1 || '';
                document.getElementById('editPhone2').value = user.phone2 || '';
                document.getElementById('editCompanyName').value = user.company_name || '';
                document.getElementById('editPassword').value = user.password || '';
                
                editUserModal.style.display = 'flex';
            } catch (error) {
                showNotification('خطأ', 'فشل تحميل بيانات المستخدم للتعديل', 'error');
            }
        }

        function closeEditUserModal() {
            editUserModal.style.display = 'none';
        }

        async function saveUserChanges() {
            if (!currentUserId) return;
            const formData = {
                full_name: document.getElementById('editFullName').value,
                birth_date: document.getElementById('editBirthDate').value,
                address: document.getElementById('editAddress').value,
                phone1: document.getElementById('editPhone1').value,
                phone2: document.getElementById('editPhone2').value,
                company_name: document.getElementById('editCompanyName').value,
                password: document.getElementById('editPassword').value,
                updated_at: new Date().toISOString(),
            };

            try {
                const { error } = await supabaseClient.from('users').update(formData).eq('id', currentUserId);
                if (error) throw error;
                showNotification('نجاح', 'تم تحديث بيانات المستخدم بنجاح', 'success');
                closeEditUserModal();
                loadUserDetail(currentUserId); // Refresh detail view
                loadUsers(); // Refresh users list
            } catch (error) {
                showNotification('خطأ', 'فشل تحديث بيانات المستخدم', 'error');
            }
        }

        // DELETE USER
        function confirmDeleteUser() {
            if (!currentUserId) return;
            currentDeleteAction = 'user';
            currentDeleteId = currentUserId;
            deleteConfirmMessage.textContent = 'هل أنت متأكد من حذف هذا المستخدم؟ سيتم حذف جميع بياناته ومنشوراته نهائياً.';
            deleteConfirmModal.style.display = 'flex';
        }

        // DELETE POST
        function confirmDeletePost(postId) {
            currentDeleteAction = 'post';
            currentDeleteId = postId;
            deleteConfirmMessage.textContent = 'هل أنت متأكد من حذف هذا المنشور؟';
            deleteConfirmModal.style.display = 'flex';
        }

        function closeDeleteModal() {
            deleteConfirmModal.style.display = 'none';
            currentDeleteAction = null;
            currentDeleteId = null;
        }

        // Attach event listener to the confirm button
        confirmDeleteBtn.onclick = async function() {
            if (currentDeleteAction === 'user') {
                await executeDeleteUser();
            } else if (currentDeleteAction === 'post') {
                await executeDeletePost();
            }
            closeDeleteModal();
        }

        async function executeDeleteUser() {
            if (!currentDeleteId) return;
            try {
                // 1. Delete posts from msg3
                await supabaseClient.from('msg3').delete().eq('user_id', currentDeleteId);
                // 2. Delete posts from msg2 (if any)
                await supabaseClient.from('msg2').delete().eq('user_id', currentDeleteId);
                // 3. Delete the user
                const { error } = await supabaseClient.from('users').delete().eq('id', currentDeleteId);
                if (error) throw error;

                showNotification('نجاح', 'تم حذف المستخدم وجميع بياناته بنجاح', 'success');
                showUsersList(); // Go back to list view
                loadUsers(); // Refresh the list
                loadCounters(); // Update counters
            } catch (error) {
                console.error('Delete user error:', error);
                showNotification('خطأ', 'فشل حذف المستخدم', 'error');
            }
        }

        async function executeDeletePost() {
            if (!currentDeleteId) return;
            try {
                // جلب بيانات المنشور قبل حذفه
                const { data: post, error: fetchError } = await supabaseClient
                    .from('msg3')
                    .select('images, payment_image_url')
                    .eq('id', currentDeleteId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // حذف المنشور
                const { error: deleteError } = await supabaseClient
                    .from('msg3')
                    .delete()
                    .eq('id', currentDeleteId);
                
                if (deleteError) throw deleteError;
                
                // حذف الصور المرتبطة بالمنشور
                if (post.images && post.images.length > 0) {
                    for (const imageUrl of post.images) {
                        try {
                            const parts = imageUrl.split('/');
                            const bucketIndex = parts.findIndex(part => part === 'property-images');
                            if (bucketIndex !== -1) {
                                const filePath = parts.slice(bucketIndex + 1).join('/');
                                await supabaseClient.storage.from('property-images').remove([filePath]);
                            }
                        } catch (err) {
                            // تجاهل أخطاء حذف الصور
                        }
                    }
                }
                
                // حذف صورة إثبات الدفع إذا وجدت
                if (post.payment_image_url) {
                    try {
                        const parts = post.payment_image_url.split('/');
                        const bucketIndex = parts.findIndex(part => part === 'payment-proofs');
                        if (bucketIndex !== -1) {
                            const filePath = parts.slice(bucketIndex + 1).join('/');
                            await supabaseClient.storage.from('payment-proofs').remove([filePath]);
                        }
                    } catch (err) {
                        // تجاهل أخطاء حذف صورة الدفع
                    }
                }
                
                showNotification('نجاح', 'تم حذف المنشور بنجاح', 'success');
                loadUserDetail(currentUserId); // Refresh the detail view
                loadCounters(); // Update counters
            } catch (error) {
                console.error('Delete post error:', error);
                showNotification('خطأ', 'فشل حذف المنشور', 'error');
            }
        }

    </script>
    
    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</body>
</html>