<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>تثبيت تطبيق أيين</title>

<!-- روابط نسبية (تأكد أن الملفات موجودة في نفس المجلد) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b7ed1">
<link rel="apple-touch-icon" href="ayn-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Ayn">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  body{font-family: "Tajawal", sans-serif;background:#f4f6f8;margin:0;padding:20px;text-align:center}
  .card{background:#fff;border-radius:16px;box-shadow:0 6px 25px rgba(0,0,0,0.08);padding:25px;max-width:420px;margin:40px auto}
  h1{margin-top:0;color:#0b7ed1}
  p{color:#444;line-height:1.6}
  .btn{display:inline-block;margin:8px;padding:12px 18px;border-radius:10px;text-decoration:none;font-weight:600;background:#0b7ed1;color:#fff;border:none;cursor:pointer; transition: background-color 0.2s;}
  .btn:hover { background-color: #0968b3; }
  .modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
  .modal-content{background:#fff;margin:18% auto;padding:18px;border-radius:12px;width:86%;max-width:380px;text-align:center}
  .close{background:#eee;border:none;padding:8px 12px;border-radius:8px;margin-top:10px;cursor:pointer}
  #status { margin-top: 15px; font-weight: 600; color: #28a745; }
</style>
</head>
<body>

<div class="card">
  <img src="ayn-180.png" alt="شعار أيين" style="width:90px;margin-bottom:15px;">
  <h1>تثبيت تطبيق أيين</h1>
  <p>احصل على أفضل تجربة عبر تثبيت التطبيق على جهازك.</p>

  <!-- زر التثبيت لأندرويد (سيتم إظهاره/إخفاؤه بواسطة JavaScript) -->
  <button id="installBtn" class="btn" style="display: none;">🤖 تثبيت التطبيق</button>

  <!-- زر iOS (سيتم إظهاره فقط على أجهزة آيفون) -->
  <button id="iosBtn" class="btn" style="display: none;"> تثبيت على آيفون</button>

  <!-- رسالة الحالة -->
  <div id="status"></div>
</div>

<!-- مودال iPhone -->
<div id="iosModal" class="modal">
  <div class="modal-content">
    <h3>تثبيت على آيفون</h3>
    <p>لتثبيت التطبيق على شاشة آيفون:</p>
    <ol style="text-align:right; direction:rtl;">
      <li>افتح هذه الصفحة في متصفح <strong>Safari</strong>.</li>
      <li>اضغط زر <strong>المشاركة (Share)</strong>.</li>
      <li>اختر <strong>Add to Home Screen</strong> ثم اضغط <strong>Add</strong>.</li>
    </ol>
    <button class="close">إغلاق</button>
  </div>
</div>

<script>
/* ============================
   تسجيل Service Worker
   ============================ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker registered successfully.'))
    .catch(e => console.warn('Service Worker registration failed:', e));
}

/* ============================
   منطق التثبيت التلقائي (PWA)
   ============================ */

let deferredPrompt; // لتخزين حدث التثبيت
const installBtn = document.getElementById('installBtn');
const iosBtn = document.getElementById('iosBtn');
const iosModal = document.getElementById('iosModal');
const statusDiv = document.getElementById('status');

// التحقق من نوع الجهاز
const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());

if (isIos) {
  // إذا كان الجهاز آيفون، أظهر زر الآيفون
  iosBtn.style.display = 'inline-block';
} else {
  // إذا لم يكن آيفون، استمع لحدث التثبيت
  window.addEventListener('beforeinstallprompt', (e) => {
    // منع المتصفح من عرض المطالبة الافتراضية
    e.preventDefault();
    // حفظ الحدث لاستخدامه لاحقًا
    deferredPrompt = e;
    // إظهار زر التثبيت المخصص
    installBtn.style.display = 'inline-block';
  });

  // عند الضغط على زر التثبيت
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) {
      return;
    }
    // إظهار مطالبة التثبيت
    deferredPrompt.prompt();
    // إخفاء الزر لأنه لا يجب عرضه مرة أخرى
    installBtn.style.display = 'none';
    // انتظار رد المستخدم
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response to the install prompt: ${outcome}`);
    
    if (outcome === 'accepted') {
      statusDiv.textContent = 'شكرًا لك! تم تثبيت التطبيق بنجاح.';
    } else {
      statusDiv.textContent = 'تم إلغاء التثبيت.';
    }
    // مسح الحدث المحفوظ
    deferredPrompt = null;
  });
}

/* ============================
   التعامل مع مودال الآيفون
   ============================ */
iosBtn.onclick = () => iosModal.style.display = 'block';
document.querySelector('.close').onclick = () => iosModal.style.display = 'none';
window.onclick = e => { if (e.target === iosModal) iosModal.style.display = 'none'; };

</script>

</body>
</html>
